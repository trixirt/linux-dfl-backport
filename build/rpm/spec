Name:               linux-dfl-backport
Version:            %{getenv:BACKPORT_VERSION}
Release:            1
Summary:            Backported kernel modules for in-development linux fpga dfl modules
License:            GPLv2+
Group:              System/Kernel and hardware
URL:                https://github.com/OPAE/linux-dfl/
BuildArch:          noarch
Requires:           dkms, (kernel-devel if kernel), (kernel-rt-devel if kernel-rt)

%define _dstdir %{_usrsrc}/linux-dfl-backport-%{version}-%{release}
%define _pkgdir %{buildroot}%{_dstdir}

%define _regmapdstdir %{_usrsrc}/regmap-mmio-backport-%{version}-%{release}
%define _regmappkgdir %{buildroot}%{_regmapdstdir}

%description
Device Feature List (dfl) is used by FPGAs to communicate features
supported by a given loaded firmware/bitstream. Since dfl support in the
Linux kernel has yet to materialize, this package contains a backported
version of the current dfl support.

%install
install -d %{_pkgdir}
cp -a build/dkms/dkms.conf Makefile drivers include %{_pkgdir}

install -d  %{_regmappkgdir}/drivers/base/regmap
install -m644 build/dkms/regmap-mmio.conf %{_regmappkgdir}/dkms.conf
install -m644 build/regmap-mmio.rules %{_regmappkgdir}/Makefile
install -m755 build/dkms/symvers.sh %{_regmappkgdir}
mv %{_pkgdir}/drivers/base/regmap/{internal.h,regmap-mmio.c} %{_regmappkgdir}/drivers/base/regmap/

%post
dkms add regmap-mmio-backport/%{version}-%{release} --rpm_safe_upgrade
dkms add %{name}/%{version}-%{release} --rpm_safe_upgrade
dkms autoinstall %{name}/%{version}-%{release} --rpm_safe_upgrade

%preun
dkms remove %{name}/%{version}-%{release} --rpm_safe_upgrade --all
dkms remove regmap-mmio-backport/%{version}-%{release} --rpm_safe_upgrade --all

%postun
rmdir %{_dstdir} %{_regmapdstdir}

%files
%defattr(-,root,root)
%{_dstdir}/*
